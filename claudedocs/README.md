# 密码锁功能设计文档导航

本目录包含 SiYuan Password 项目的所有设计文档，按版本组织。

## 📂 目录结构

```
claudedocs/
├── README.md                                          # 本文档（文档导航）
├── 密码锁功能完整实施文档_v3.1修复版.md                  # v3.1 修复版（最新 - 推荐）
├── v3.0/                                              # v3.0 完整实施版本
│   ├── 密码锁功能完整实施文档.md                        # 完整实施文档
│   ├── 文档改进说明.md                                 # 改进说明
│   └── 最终交付总结.md                                 # 交付总结
└── v2.1/                                              # v2.1 源码验证版本
    ├── 笔记加锁功能设计文档.md                          # 核心设计
    ├── 技术实现细节补充文档.md                          # 完整技术实现
    └── 文档评估报告.md                                 # 文档质量评估
```

---

## 🎯 推荐阅读顺序

### 快速上手（推荐）

如果你想快速开始实现密码锁功能，按以下顺序阅读：

1. **密码锁功能完整实施文档_v3.1修复版.md** ⭐⭐⭐⭐⭐
   - 最新、最完整的实施文档
   - 包含修复的数据库路径问题
   - 生产就绪的代码实现
   - **推荐作为主要参考**

### 深入理解架构

如果你想深入理解设计决策和架构，按以下顺序阅读：

1. **v2.1/笔记加锁功能设计文档.md** - 核心设计理念
   - 功能概述和架构设计
   - 数据结构和表定义
   - 密码验证流程
   - 云同步策略（已通过源码验证 ✅）
   - 防暴力破解机制

2. **v2.1/技术实现细节补充文档.md** - 详细技术实现
   - DatabaseService 实现（500+ 行代码）
   - PasswordManager 核心逻辑（700+ 行代码）
   - Hook 拦截实现
   - WebSocket 事件处理
   - 云同步兼容性分析
   - 完整测试计划

3. **密码锁功能完整实施文档_v3.1修复版.md** - 完整实施
   - 在理解架构后，参考最新实施指南

---

## 📖 版本说明

### v3.1 修复版（2025-12-31）- 推荐使用 ⭐

**文件**: `密码锁功能完整实施文档_v3.1修复版.md`

**状态**: ✅ 生产就绪

**特点**:
- 修复了 v3.0 中的数据库路径错误（`/data/storage/petal/siyuan-password/` 而非 `/data/plugins/siyuan-password/`）
- 完整的插件实现代码
- 包含完整的测试用例
- 生产环境部署指南

**适用场景**:
- 直接实施密码锁功能
- 生产环境部署
- 代码参考和复制

---

### v3.0 完整实施（2025-12-30）

**目录**: `v3.0/`

**状态**: ⚠️ 存在已知问题（数据库路径错误）

**特点**:
- 完整的功能实施方案
- 详细的代码实现
- UI 组件和交互设计
- ❌ 数据库路径使用了错误的 `/data/plugins/` 前缀

**适用场景**:
- 了解功能演进历程
- 参考 UI 设计
- **不推荐直接使用**（请使用 v3.1 修复版）

**主要文档**:
- `密码锁功能完整实施文档.md` - 主实施文档
- `文档改进说明.md` - 从 v2.1 到 v3.0 的改进
- `最终交付总结.md` - 交付总结

---

### v2.1 源码验证（2025-12-30）

**目录**: `v2.1/`

**状态**: ✅ 已通过源码验证

**特点**:
- 基于思源笔记源码验证的设计
- 深入的架构分析
- 详细的技术决策文档
- 完整的代码示例（DatabaseService, PasswordManager 等）

**适用场景**:
- 理解设计决策
- 学习架构模式
- 深入技术细节
- 源码级别的技术参考

**主要文档**:

1. **笔记加锁功能设计文档.md** (核心设计)
   - 总长度: ~15,000 字
   - 章节数: 9 章
   - 包含: 架构设计、数据模型、流程图、开发计划
   - 验证状态: ✅ 所有关键决策已通过源码验证

2. **技术实现细节补充文档.md** (实现指南)
   - 总长度: ~20,000 字
   - 代码量: 1,500+ 行完整示例代码
   - 章节数: 10 章
   - 包含: 完整实现代码、错误处理、性能优化、测试计划

3. **文档评估报告.md** (质量评估)
   - 文档完整性评估
   - 改进优先级建议
   - 开发工作量估算

---

## 🔍 关键主题索引

### 架构设计

| 主题 | v2.1 设计文档 | v2.1 技术细节 | v3.1 修复版 |
|------|--------------|--------------|------------|
| 插件架构 | 第2章 | 第1章 | 第2.1章 |
| 数据库设计 | 第3.2章 | 第2章 | 第3章 |
| Hook 拦截机制 | 第4.1章 | 第3章 | 第4.1章 |
| 云同步策略 | 第3.5章 | 第6章 | 第4.3章 |

### 核心功能

| 功能 | v2.1 设计文档 | v2.1 技术细节 | v3.1 修复版 |
|------|--------------|--------------|------------|
| 密码加密（bcrypt） | 第4.2章 | 第2.3章 | 第4.2.1章 |
| 防暴力破解 | 第4.3章 | 第2.5章 | 第4.2.2章 |
| 内存安全保护 | 第3.4章 | 第2.4章 | 第4.2.3章 |
| WebSocket 事件处理 | 第4.4章 | 第5章 | 第4.4章 |
| 审计日志 | 第3.6章 | 第2.6章 | 第4.2.4章 |

### 实现代码

| 组件 | v2.1 技术细节 | v3.1 修复版 |
|------|--------------|------------|
| DatabaseService | 第2章（500行） | 第6.1章 |
| PasswordManager | 第2章（700行） | 第6.2章 |
| DocumentOpenInterceptor | 第3章 | 第6.3章 |
| WebSocketEventHandler | 第5章 | 第6.4章 |
| UIManager | 第4章 | 第6.5章 |

### 测试与质量

| 主题 | v2.1 技术细节 | v3.1 修复版 |
|------|--------------|------------|
| 单元测试 | 第10章 | 第8章 |
| 集成测试 | 第10章 | 第8章 |
| 边缘用例 | 第7章 | 第7章 |
| 安全审计 | 第9章 | 第9章 |
| 性能优化 | 第8章 | 附录B |

---

## 🚀 开发路线图

完整的开发路线图参见：
- **v2.1**: `v2.1/笔记加锁功能设计文档.md` 第8章 - 开发计划（Phase 0-3，共9.5周）
- **v3.1**: `密码锁功能完整实施文档_v3.1修复版.md` 第10章 - 实施计划

---

## ⚠️ 已知问题和修复

### v3.0 → v3.1 主要修复

1. **数据库路径错误** ❌ → ✅
   - v3.0: `/data/plugins/siyuan-password/password_locks.db`（错误）
   - v3.1: `/data/storage/petal/siyuan-password/password_locks.db`（正确）
   - **影响**: v3.0 的数据库路径不会被自动云同步
   - **修复**: v3.1 修正为正确的插件存储路径

2. **云同步兼容性** ⚠️ → ✅
   - v3.0: 未明确说明云同步路径
   - v3.1: 明确说明 `/data/storage/petal/` 路径自动云同步（已源码验证）

### v2.1 源码验证结果

以下关键决策已通过源码验证 ✅:

1. **WebSocket 事件聚合** - 思源已实现 EventBus，无需修改
2. **云同步策略** - `kernel/repository.go` 自动处理 `/storage/petal/` 路径
3. **openFileById Hook** - `app/src/editor/util.ts:39` 拦截点已确认可行
4. **笔记本嵌套** - Box 结构体无 `parentId` 字段，采用单层设计

---

## 📚 相关文档

- **项目主文档**: [../CLAUDE.md](../CLAUDE.md) - Claude Code 项目文档
- **贡献指南**: [../CONTRIBUTING.md](../CONTRIBUTING.md) - 项目贡献原则
- **用户文档**: [../README.md](../README.md) - 用户使用手册
- **API 文档**: [../API_zh_CN.md](../API_zh_CN.md) - 思源笔记 API 参考
- **补丁说明**: [../patches/README.md](../patches/README.md) - 补丁文件说明

---

## 🤝 文档贡献

如果你发现文档中的错误或需要改进的地方，欢迎：

1. 提交 Issue：[GitHub Issues](https://github.com/yangpf5271/siyuan-password/issues)
2. 提交 Pull Request（参见 [CONTRIBUTING.md](../CONTRIBUTING.md)）

**文档维护原则**:
- v3.1 修复版是**推荐使用**的版本，应保持最新
- 历史版本（v2.1, v3.0）保留用于参考和理解演进过程
- 所有文档修改应更新本 README.md 的索引

---

**最后更新**: 2026-01-02
**维护者**: yangpf5271

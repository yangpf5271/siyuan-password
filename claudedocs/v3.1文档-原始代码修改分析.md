# v3.1 文档原始代码修改分析

**文档版本**: v3.1 修复版
**分析日期**: 2026-01-02
**分析对象**: `claudedocs/密码锁功能完整实施文档_v3.1修复版.md`

---

## 📋 执行摘要

**重要结论**: ✅ **v3.1 文档采用纯插件模式，不修改任何思源笔记原始代码文件**

v3.1 文档的设计完全遵循项目的核心原则：
- ✅ 补丁文件保持与上游一致
- ✅ 密码锁功能作为独立插件实现
- ✅ 通过插件 API 和 Hook 机制实现所有功能
- ✅ 不直接修改核心代码

---

## 🔍 详细分析

### 1. 不修改的原始代码文件

根据文档第 1.3 节"源码验证结果"，以下核心功能**已验证且无需修改**：

| 功能 | 原始文件位置 | 验证结果 | 说明 |
|------|-------------|---------|------|
| WebSocket 事件聚合 | `app/src/plugin/EventBus.ts` | ✅ 无需修改 | 思源已正确实现 EventBus 模式 |
| 插件数据存储 | `app/src/plugin/index.ts` | ✅ 无需修改 | Plugin.saveData/loadData API 已存在 |
| removeDoc 事件 | `app/src/index.ts` | ✅ 无需修改 | WebSocket 事件已正确广播 |
| unmount 事件 | `app/src/index.ts` | ✅ 无需修改 | 笔记本卸载事件已存在 |
| 云同步机制 | `kernel/repository.go` | ✅ 无需修改 | 自动处理 `/storage/petal/` 路径 |

---

### 2. Hook 拦截机制（运行时覆盖，非文件修改）

**关键技术**: 运行时 Hook `window.openFileById` 函数

#### 原理说明

v3.1 文档使用 **JavaScript 函数 Hook** 技术，在**运行时**拦截 `openFileById` 函数调用，而**不修改**原始的 `app/src/editor/util.ts:39` 文件。

#### 实现代码（第 1290-1336 行）

```typescript
export class DocumentOpenInterceptor {
    private originalOpenFileById: any;

    /**
     * 安装 Hook（运行时覆盖）
     */
    install(): void {
        // 1. 保存原始函数引用
        this.originalOpenFileById = window.openFileById;

        // 2. 替换为自定义函数（运行时）
        window.openFileById = async function (options: any) {
            // 密码验证逻辑
            const allowed = await self.interceptOpen(options?.id);
            if (!allowed) return;

            // 调用原始函数
            return self.originalOpenFileById.call(this, options);
        };

        // 3. 定期检查 Hook 是否被覆盖
        this.checkInterval = window.setInterval(() => {
            if (window.openFileById !== arguments.callee) {
                console.warn("⚠️ openFileById Hook has been overridden!");
                self.reinstall();
            }
        }, 5000);
    }

    /**
     * 卸载 Hook（恢复原始函数）
     */
    uninstall(): void {
        window.clearInterval(this.checkInterval);
        window.openFileById = this.originalOpenFileById;
    }
}
```

#### 关键特点

| 特性 | 说明 |
|------|------|
| **非侵入式** | 不修改 `app/src/editor/util.ts` 源文件 |
| **运行时覆盖** | 在插件加载时动态替换 `window.openFileById` |
| **可逆操作** | 插件卸载时恢复原始函数 |
| **自我修复** | 每 5 秒检查 Hook 是否被覆盖，自动重新安装 |

---

### 3. 插件文件结构（新增文件，非修改文件）

v3.1 文档设计的所有文件都是**新增插件文件**，位于插件目录 `app/src/plugins/password-lock/`：

```
app/src/plugins/password-lock/
├── index.ts                      # ✨ 插件入口点（PasswordLockPlugin 类）
├── src/
│   ├── database.ts              # ✨ DatabaseService + AuditLogger
│   ├── password-manager.ts      # ✨ PasswordManager + SecureUnlockManager
│   ├── interceptor.ts           # ✨ DocumentOpenInterceptor (Hook)
│   ├── notebook-interceptor.ts  # ✨ NotebookOpenInterceptor (新增)
│   ├── backup-manager.ts        # ✨ BackupManager (新增)
│   ├── sync-handler.ts          # ✨ SyncConflictResolver (新增)
│   ├── ws-event-handler.ts      # ✨ WebSocketEventHandler
│   └── ui-manager.ts            # ✨ UIManager (密码对话框等)
├── plugin.json                  # ✨ 插件配置文件
└── README.md                    # ✨ 插件说明文档
```

**所有文件标记**: ✨ = 新增文件（非修改现有文件）

---

### 4. 核心模块功能映射

| 模块 | 职责 | 文件位置 | 修改类型 |
|------|------|---------|---------|
| **DatabaseService** | JSON 数据库 CRUD 操作 | `src/database.ts` | ✨ 新增 |
| **PasswordManager** | 密码验证、防暴力破解 | `src/password-manager.ts` | ✨ 新增 |
| **SecureUnlockManager** | WeakMap 内存保护 | `src/password-manager.ts` | ✨ 新增 |
| **BackupManager** | 自动备份和恢复 | `src/backup-manager.ts` | ✨ 新增 |
| **SyncConflictResolver** | 云同步冲突解决 | `src/sync-handler.ts` | ✨ 新增 |
| **DocumentOpenInterceptor** | openFileById Hook 拦截 | `src/interceptor.ts` | ✨ 新增（Hook） |
| **NotebookOpenInterceptor** | 笔记本打开拦截 | `src/notebook-interceptor.ts` | ✨ 新增 |
| **WebSocketEventHandler** | WebSocket 事件监听 | `src/ws-event-handler.ts` | ✨ 新增 |
| **UIManager** | 密码对话框等 UI 组件 | `src/ui-manager.ts` | ✨ 新增 |
| **AuditLogger** | 操作审计记录 | `src/database.ts` | ✨ 新增 |

---

### 5. 实现方式对比

#### 方式 A: 修改核心代码（❌ v3.1 未采用）

```typescript
// ❌ 不推荐：直接修改 app/src/editor/util.ts
export const openFileById = async (options: any) => {
    // 在原始函数中添加密码验证逻辑
    const passwordLock = getPasswordLock(options.id);
    if (passwordLock && !isUnlocked(options.id)) {
        await showPasswordDialog(options.id);
    }
    // ... 原始打开逻辑
};
```

**缺点**:
- ❌ 违反项目原则（不修改核心代码）
- ❌ 上游同步时产生冲突
- ❌ 难以维护和升级
- ❌ 无法独立启用/禁用功能

#### 方式 B: 插件 Hook 模式（✅ v3.1 采用）

```typescript
// ✅ 推荐：插件模式运行时 Hook
class DocumentOpenInterceptor {
    install(): void {
        // 保存原始函数
        this.originalOpenFileById = window.openFileById;

        // 运行时替换
        window.openFileById = async (options: any) => {
            // 密码验证逻辑
            const allowed = await this.interceptOpen(options?.id);
            if (!allowed) return;

            // 调用原始函数
            return this.originalOpenFileById.call(this, options);
        };
    }
}
```

**优点**:
- ✅ 不修改核心代码文件
- ✅ 插件可独立启用/禁用
- ✅ 上游同步无冲突
- ✅ 易于维护和升级
- ✅ 符合项目架构原则

---

### 6. WebSocket 事件处理（监听模式，非修改）

v3.1 文档使用**事件监听**模式，通过插件的 `eventBus` 订阅 WebSocket 事件：

```typescript
// ✅ 插件模式：事件监听（不修改 app/src/index.ts）
class WebSocketEventHandler {
    constructor(plugin: Plugin, passwordManager: PasswordManager) {
        // 订阅 ws-main 事件
        plugin.eventBus.on('ws-main', async (data) => {
            switch (data.cmd) {
                case 'removeDoc':
                    // 处理文档删除
                    await this.handleDocumentRemoved(data.data.id);
                    break;

                case 'unmount':
                    // 处理笔记本卸载
                    await this.handleNotebookUnmounted(data.data.box);
                    break;
            }
        });
    }
}
```

**原理**: 思源笔记的 `app/src/index.ts` 已实现事件广播机制，插件无需修改源文件即可订阅事件。

---

### 7. 数据存储（插件 API，非修改）

v3.1 文档使用思源提供的 **Plugin API** 进行数据存储：

```typescript
// ✅ 插件模式：使用 Plugin API（不修改核心代码）
class DatabaseService {
    async save(data: DatabaseSchema): Promise<void> {
        // 使用插件 API 保存数据
        await this.plugin.saveData(
            'password_locks.db',  // 文件名
            data                   // JSON 对象
        );
    }

    async load(): Promise<DatabaseSchema | null> {
        // 使用插件 API 加载数据
        return await this.plugin.loadData('password_locks.db');
    }
}
```

**存储路径**: `/data/storage/petal/siyuan-password/password_locks.db`

**特点**:
- ✅ 使用思源提供的 `Plugin.saveData()` API
- ✅ 自动云同步（`kernel/repository.go` 自动处理）
- ✅ 不需要修改核心代码

---

## 🎯 结论

### 修改原始代码的文件数量: **0 个**

v3.1 文档完全采用**纯插件模式**，遵循项目核心原则：

| 项目原则 | v3.1 文档实现 | 验证 |
|---------|--------------|------|
| 补丁文件保持一致 | 不涉及补丁文件 | ✅ |
| 插件化开发 | 所有功能作为插件实现 | ✅ |
| 不修改核心代码 | 0 个核心文件被修改 | ✅ |
| 代码质量标准 | TypeScript + ESLint | ✅ |

### 技术实现总结

| 功能类别 | 实现方式 | 是否修改核心代码 |
|---------|---------|----------------|
| **文档打开拦截** | 运行时 Hook `window.openFileById` | ❌ 否 |
| **笔记本打开拦截** | WebSocket 事件监听 | ❌ 否 |
| **数据存储** | Plugin.saveData/loadData API | ❌ 否 |
| **云同步** | 依赖思源自动同步机制 | ❌ 否 |
| **WebSocket 事件** | EventBus 订阅模式 | ❌ 否 |
| **UI 组件** | 插件自有 UI 组件 | ❌ 否 |

### 新增文件清单

**插件文件**（共 10 个）:
1. `index.ts` - 插件入口点
2. `src/database.ts` - 数据库服务
3. `src/password-manager.ts` - 密码管理器
4. `src/interceptor.ts` - 文档打开拦截器（Hook）
5. `src/notebook-interceptor.ts` - 笔记本拦截器
6. `src/backup-manager.ts` - 备份管理器
7. `src/sync-handler.ts` - 云同步冲突解决
8. `src/ws-event-handler.ts` - WebSocket 事件处理器
9. `src/ui-manager.ts` - UI 管理器
10. `plugin.json` - 插件配置

**配置文件**（可选）:
- `webpack.config.js` - Webpack 配置（如果插件需要独立打包）

---

## ⚠️ 注意事项

### 1. Hook 机制的局限性

虽然 Hook 机制不修改源文件，但存在以下注意事项：

| 问题 | 解决方案 |
|------|---------|
| 其他插件可能覆盖 Hook | 定期检查并重新安装（每 5 秒） |
| 思源更新可能改变函数签名 | 版本兼容性测试 |
| 函数名称可能改变 | 监控思源更新日志 |

### 2. 依赖思源核心功能

| 依赖功能 | 风险 | 缓解措施 |
|---------|------|---------|
| `window.openFileById` 存在 | 思源移除该函数 | 监控思源更新，准备备用方案 |
| WebSocket 事件广播 | 事件机制改变 | 使用官方插件 API |
| `/storage/petal/` 云同步 | 同步机制改变 | 基于官方文档实现 |

### 3. 与项目原则的一致性

✅ **完全符合项目核心原则**:
- 补丁文件保持 100% 一致（不涉及补丁）
- 插件化开发（所有功能作为插件）
- 不修改核心代码（0 个核心文件修改）

---

## 📚 参考文档

- **v3.1 完整文档**: `claudedocs/密码锁功能完整实施文档_v3.1修复版.md`
- **项目贡献指南**: `CONTRIBUTING.md`
- **Claude 开发文档**: `CLAUDE.md`
- **v2.1 核心设计**: `claudedocs/v2.1/笔记加锁功能设计文档.md`
- **v2.1 技术细节**: `claudedocs/v2.1/技术实现细节补充文档.md`

---

**分析完成日期**: 2026-01-02
**分析人员**: Claude Code
**文档状态**: ✅ 已验证
